services:
  # app_proxy:
  #   environment:
  #     APP_HOST: pluto-next_frontend_1 # Hostname of the pluto application
  #     APP_PORT: 7677 # Port number of the pluto application
  #   # ports:
  #   #   - "7677:7677" # Proxy listens on port 7677 on the host and forwards to APP_HOST:APP_PORT
  #   depends_on:
  #     - frontend
  #   restart: on-failure

  mock:
    # build:
    #   context: .
    #   dockerfile: mock/Dockerfile
    image: ghcr.io/plutomining/pluto-mock:1.0.0-beta.0@sha256:6c1a764c994477203fc70e5a4fdb5a5e061a29bbb84b2b1c7935a38a768b483c
    container_name: pluto-next_mock_1
    ports:
      - "7670:7670"
      - "7651:7651"
      - "7652:7652"
      - "7653:7653"
      - "7654:7654"
      - "7655:7655"
      - "7656:7656"
      - "7657:7657"
      - "7658:7658"
      - "7659:7659"
      - "7660:7660"
    pid: host

    # Container restart policy - restart unless manually stopped
    restart: on-failure
    # env_file:
    #   - mock/.env.local
    environment:
      - LISTING_PORT=7670
      - PORTS=7651,7652,7653,7654,7655,7656,7657,7658,7659,7660
      - LOGS_PUB_ENABLED=false
    # volumes:
    #   - ./common/logger:/common/logger:ro # Monta il modulo in read-only
    #   - ./common/interfaces:/common/interfaces:ro # Monta il modulo in read-only
    #   - ./mock:/home/node/app/
    user: "1000:1000"

  discovery:
    # build:
    #   context: .
    #   dockerfile: discovery/Dockerfile
    image: ghcr.io/plutomining/pluto-discovery:2.0.0-beta.0@sha256:5f04d73a85a29f69cc6b5a4f16400f713c621ae57745c62792e9eb3cfec167ea
    container_name: pluto-next_discovery_1
    network_mode: "host"
    # ports:
    #   - "7675:7675" # Map port 7675 on the host to port 7675 on the container
    pid: host
    cap_add:
      - NET_RAW
      - NET_ADMIN

    # Container restart policy - restart unless manually stopped
    restart: on-failure
    env_file:
      - discovery/.env.next.local
    environment:
      - PORT=7675
      - DETECT_MOCK_DEVICES=true
      - MOCK_DISCOVERY_HOST=http://localhost:7670
      - MOCK_DEVICE_HOST=172.17.0.1
      # - MOCK_DISCOVERY_HOST=http://172.17.0.1:7670
    volumes:
      # - ./common/interfaces:/common/interfaces:ro # Monta il modulo in read-only
      # - ./common/db:/common/db:ro # Monta il modulo in read-only
      # - ./common/logger:/common/logger:ro # Monta il modulo in read-only
      # - ./discovery:/home/node/app/
      - ./data/leveldb-next:/home/node/app/data
    user: "1000:1000"

  backend:
    # build:
    #   context: .
    #   dockerfile: backend/Dockerfile
    image: ghcr.io/plutomining/pluto-backend:3.0.0-beta.0@sha256:b2b86aeb043fda0c054b78a67abb765f2e51c3c80595bd79771bf4f5523a83fe
    container_name: pluto-next_backend_1
    # ports:
    #   - "7676:7676"
    pid: host

    # Container restart policy - restart unless manually stopped
    restart: on-failure
    env_file:
      - backend/.env.next.local
    environment:
      - PORT=7676
      - AUTO_LISTEN=true
      - DISCOVERY_SERVICE_HOST=http://172.17.0.1:7675
      - DELETE_DATA_ON_DEVICE_REMOVE=true
    volumes:
      #Â - ./common/utils:/common/utils:ro # Monta il modulo in read-only
      # - ./common/interfaces:/common/interfaces:ro # Monta il modulo in read-only
      # - ./common/db:/common/db:ro # Monta il modulo in read-only
      # - ./common/logger:/common/logger:ro # Monta il modulo in read-only
      # - ./backend:/home/node/app/
      - ./data/leveldb-next:/home/node/app/data
    depends_on:
      prometheus:
        condition: service_healthy
    user: "1000:1000"

  frontend:
    # build:
    #   context: .
    #   dockerfile: frontend/Dockerfile
    image: ghcr.io/plutomining/pluto-frontend:3.0.0-beta.1@sha256:bbe8561a5090c95199903379256af42f95b2b5a9087e484293be005ddc8600ce
    container_name: pluto-next_frontend_1
    ports:
      - "7677:7677" # Map port 7777 on the host to port 7777 on the container
    # Use the host's PID namespace to allow container processes to be visible on the host
    pid: host

    # Container restart policy - restart unless manually stopped
    restart: on-failure
    depends_on:
      - backend
    # env_file:
    #   - frontend/.env.local
    environment:
      - PORT=7677
      - BACKEND_DESTINATION_HOST=http://pluto-next_backend_1:7676
    volumes:
      - ./umbrel-apps/pluto-next/umbrel-app.yml:/tmp/umbrel-app.yml:ro
    #   - ./common/utils:/common/utils:ro # Monta il modulo in read-only
    #   - ./common/interfaces:/common/interfaces:ro # Monta il modulo in read-only
    #   - ./frontend:/home/node/app/
    user: "1000:1000"

  prometheus:
    #build:
    #  context: .
    #  dockerfile: prometheus/Dockerfile.next
    image: ghcr.io/plutomining/pluto-prometheus:1.2.0-beta.3@sha256:9d6d864939e2e1b85703ea0a3f78c8e7dc87ac16c3983673dc3326689bae77fc
    container_name: pluto-next_prometheus_1
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=7d"
      - "--storage.tsdb.retention.size=5GB"
    volumes:
      - ./data/prometheus-next:/prometheus
    # ports:
    #   - "9090:9090"
    pid: host
    healthcheck:
      test:
        - "CMD-SHELL"
        - "wget --spider --quiet http://localhost:9090/-/ready || exit 1"
      interval: 10s
      timeout: 5s
      retries: 5
    user: "65534:65534"

  pyasic-bridge:
    #build:
      # context: .
      # dockerfile: pyasic-bridge/Dockerfile
    image: ghcr.io/plutomining/pluto-pyasic-bridge:1.0.0-beta.2@sha256:02781d7d33cb26937352005dfa6f079508cc9fe0df2482ce04b887608aae712a
    container_name: pluto-next_pyasic-bridge_1
    ports:
      - "8000:8000"
    environment:
      - PYTHONUNBUFFERED=1
    restart: on-failure
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/health')\" || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
