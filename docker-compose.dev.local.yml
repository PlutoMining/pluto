services:
  node_modules_permissions:
    image: node:24-alpine
    user: "0:0"
    command:
      - sh
      - -lc
      - |
        set -e
        for d in \
          /vol/backend_node_modules \
          /vol/backend_common_logger_node_modules \
          /vol/backend_common_interfaces_node_modules \
          /vol/backend_common_db_node_modules \
          /vol/backend_common_utils_node_modules \
          /vol/discovery_node_modules \
          /vol/discovery_common_logger_node_modules \
          /vol/discovery_common_interfaces_node_modules \
          /vol/discovery_common_db_node_modules \
          /vol/mock_node_modules \
          /vol/mock_common_logger_node_modules \
          /vol/mock_common_interfaces_node_modules \
          /vol/frontend_node_modules \
          /vol/frontend_common_utils_node_modules \
          /vol/frontend_common_interfaces_node_modules \
        ; do
          mkdir -p "$$d"
          chown -R 1000:1000 "$$d"
        done
    volumes:
      - backend_node_modules:/vol/backend_node_modules
      - backend_common_logger_node_modules:/vol/backend_common_logger_node_modules
      - backend_common_interfaces_node_modules:/vol/backend_common_interfaces_node_modules
      - backend_common_db_node_modules:/vol/backend_common_db_node_modules
      - backend_common_utils_node_modules:/vol/backend_common_utils_node_modules
      - discovery_node_modules:/vol/discovery_node_modules
      - discovery_common_logger_node_modules:/vol/discovery_common_logger_node_modules
      - discovery_common_interfaces_node_modules:/vol/discovery_common_interfaces_node_modules
      - discovery_common_db_node_modules:/vol/discovery_common_db_node_modules
      - mock_node_modules:/vol/mock_node_modules
      - mock_common_logger_node_modules:/vol/mock_common_logger_node_modules
      - mock_common_interfaces_node_modules:/vol/mock_common_interfaces_node_modules
      - frontend_node_modules:/vol/frontend_node_modules
      - frontend_common_utils_node_modules:/vol/frontend_common_utils_node_modules
      - frontend_common_interfaces_node_modules:/vol/frontend_common_interfaces_node_modules
    restart: "no"
  # app_proxy:
  #   image: getumbrel/app-proxy:latest
  #   environment:
  #     APP_HOST: pluto_frontend_1 # Hostname of the pluto application
  #     APP_PORT: 7777 # Port number of the pluto application
  #   # ports:
  #   #   - "7780:7777" # Proxy listens on port 7780 on the host and forwards to APP_HOST:APP_PORT
  #   depends_on:
  #     - frontend
  #   restart: on-failure

  mock:
    build:
      context: mock
      dockerfile: Dockerfile.development
    ports:
      - "7770:7770" # Map port 7770 on the host to port 7770 on the container
      - "7751:7751" # Map port 7751 on the host to port 7751 on the container
      - "7752:7752" # Map port 7752 on the host to port 7752 on the container
      - "7753:7753" # Map port 7753 on the host to port 7753 on the container
      - "7754:7754" # Map port 7754 on the host to port 7754 on the container
      - "7755:7755" # Map port 7755 on the host to port 7755 on the container
      - "7756:7756" # Map port 7756 on the host to port 7756 on the container
      - "7757:7757" # Map port 7757 on the host to port 7757 on the container
      - "7758:7758" # Map port 7758 on the host to port 7758 on the container
      - "7759:7759" # Map port 7779 on the host to port 7779 on the container
      - "7760:7760" # Map port 7760 on the host to port 7760 on the container
    pid: host

    # Container restart policy - restart unless manually stopped
    restart: on-failure
    depends_on:
      node_modules_permissions:
        condition: service_completed_successfully
    env_file:
      - mock/.env.local
    environment:
      - LISTING_PORT=7770
      - PORTS=7751,7752,7753,7754,7755,7756,7757,7758,7759,7760
      - LOGS_PUB_ENABLED=false
    volumes:
      - ./common/logger:/home/node/common/logger # Monta il modulo (writable per development)
      - ./common/interfaces:/home/node/common/interfaces # Monta il modulo (writable per development)
      - ./mock:/home/node/app/
      - mock_node_modules:/home/node/app/node_modules
      - mock_common_logger_node_modules:/home/node/common/logger/node_modules
      - mock_common_interfaces_node_modules:/home/node/common/interfaces/node_modules
    user: "1000:1000"

  discovery:
    build:
      context: discovery
      dockerfile: Dockerfile.development
    network_mode: "host"
    # ports:
    #   - "7775:7775" # Map port 7775 on the host to port 7775 on the container
    pid: host
    cap_add:
      - NET_RAW
      - NET_ADMIN

    # Container restart policy - restart unless manually stopped
    restart: on-failure
    depends_on:
      node_modules_permissions:
        condition: service_completed_successfully
    env_file:
      - discovery/.env.local
    environment:
      - PORT=7775
      - DETECT_MOCK_DEVICES=true
      # - MOCK_DISCOVERY_HOST=http://host.docker.internal:7770
    volumes:
      - ./common/interfaces:/home/node/common/interfaces # Monta il modulo (writable per development)
      - ./common/db:/home/node/common/db # Monta il modulo (writable per development)
      - ./common/logger:/home/node/common/logger # Monta il modulo (writable per development)
      - ./tooling:/home/node/tooling # Monta il modulo tooling per tsconfig.base.json
      - ./discovery:/home/node/app/
      - ./data/leveldb:/home/node/app/data
      - discovery_node_modules:/home/node/app/node_modules
      - discovery_common_logger_node_modules:/home/node/common/logger/node_modules
      - discovery_common_interfaces_node_modules:/home/node/common/interfaces/node_modules
      - discovery_common_db_node_modules:/home/node/common/db/node_modules
    user: "1000:1000"

  backend:
    build:
      context: backend
      dockerfile: Dockerfile.development
    # command:
    #   - npm
    #   - run
    #   - dev:debug
    # ports:
    #   - "7776:7776" # Map port 7776 on the host to port 7776 on the container
    #   # - "9229:9229" # Porta per il debugger
    pid: host
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # Container restart policy - restart unless manually stopped
    restart: on-failure
    env_file:
      - backend/.env.local
    environment:
      - PORT=7776
      - AUTO_LISTEN=true
      # - DISCOVERY_SERVICE_HOST=http://host.docker.internal:7775
      - DELETE_DATA_ON_DEVICE_REMOVE=true
    volumes:
      - ./common/utils:/home/node/common/utils # Monta il modulo (writable per development)
      - ./common/interfaces:/home/node/common/interfaces # Monta il modulo (writable per development)
      - ./common/db:/home/node/common/db # Monta il modulo (writable per development)
      - ./common/logger:/home/node/common/logger # Monta il modulo (writable per development)
      - ./tooling:/home/node/tooling # Monta il modulo tooling per tsconfig.base.json
      - ./backend:/home/node/app/
      - ./data/leveldb:/home/node/app/data
      - backend_node_modules:/home/node/app/node_modules
      - backend_common_logger_node_modules:/home/node/common/logger/node_modules
      - backend_common_interfaces_node_modules:/home/node/common/interfaces/node_modules
      - backend_common_db_node_modules:/home/node/common/db/node_modules
      - backend_common_utils_node_modules:/home/node/common/utils/node_modules
    depends_on:
      node_modules_permissions:
        condition: service_completed_successfully
      prometheus:
        condition: service_healthy
    healthcheck:
      test:
        - "CMD"
        - "node"
        - "-e"
        - "require('net').connect(7776,'127.0.0.1').on('connect',()=>process.exit(0)).on('error',()=>process.exit(1))"
      interval: 5s
      timeout: 3s
      retries: 20
    user: "1000:1000"

  frontend:
    build:
      context: frontend
      dockerfile: Dockerfile.development
    ports:
      - "7777:7777" # Map port 7777 on the host to port 7777 on the container
    # Use the host's PID namespace to allow container processes to be visible on the host
    pid: host

    # Container restart policy - restart unless manually stopped
    restart: on-failure
    depends_on:
      node_modules_permissions:
        condition: service_completed_successfully
      backend:
        condition: service_healthy
    # env_file:
    #   - frontend/.env.local
    environment:
      - PORT=7777
      - BACKEND_DESTINATION_HOST=http://pluto-backend-1:7776
    volumes:
      - ./common/utils:/home/node/common/utils # Monta il modulo (writable per development)
      - ./common/interfaces:/home/node/common/interfaces # Monta il modulo (writable per development)
      - ./tooling:/home/node/tooling # Monta il modulo tooling per tsconfig.base.json
      - ./frontend:/home/node/app/
      - ./umbrel-apps/pluto-next/umbrel-app.yml:/tmp/umbrel-app.yml:ro
      - frontend_node_modules:/home/node/app/node_modules
      - frontend_common_utils_node_modules:/home/node/common/utils/node_modules
      - frontend_common_interfaces_node_modules:/home/node/common/interfaces/node_modules
    user: "1000:1000"

  prometheus:
    build:
      context: prometheus
      dockerfile: Dockerfile.development
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=7d"
      - "--storage.tsdb.retention.size=5GB"
    volumes:
      - ./data/prometheus:/prometheus
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    # ports:
    #   - "9090:9090"
    pid: host
    healthcheck:
      test:
        - "CMD-SHELL"
        - "wget --spider --quiet http://localhost:9090/-/ready || exit 1"
      interval: 10s
      timeout: 5s
      retries: 5
    user: "65534:65534"

volumes:
  backend_node_modules:
  backend_common_logger_node_modules:
  backend_common_interfaces_node_modules:
  backend_common_db_node_modules:
  backend_common_utils_node_modules:
  discovery_node_modules:
  discovery_common_logger_node_modules:
  discovery_common_interfaces_node_modules:
  discovery_common_db_node_modules:
  mock_node_modules:
  mock_common_logger_node_modules:
  mock_common_interfaces_node_modules:
  frontend_node_modules:
  frontend_common_utils_node_modules:
  frontend_common_interfaces_node_modules:
